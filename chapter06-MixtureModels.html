
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>第 6 章 混合模型 &#8212; Python贝叶斯分析(中文)</title>
    
  <link href="_static/css/theme.css" rel="stylesheet">
  <link href="_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/togglebutton.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script>
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="第 7 章 高斯过程" href="chapter07-GaussianProcesses.html" />
    <link rel="prev" title="第 5 章 模型比较与模型平均" href="chapter05-ModelComparison.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Python贝叶斯分析(中文)</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="preface.html">
   封面
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  书籍正文
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="chapter01-ThinkingProbabilistically.html">
   第 1 章 概率思维
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="chapter02-ProgrammingProbabilistically.html">
   第 2 章 概率编程
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="chapter03-ModellingwithLinearRegression.html">
   第 3 章 线性回归模型
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="chapter04-GeneralizedLinearRegression.html">
   第 4 章 广义线性回归模型
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="chapter05-ModelComparison.html">
   第 5 章 模型比较与模型平均
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   第 6 章 混合模型
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="chapter07-GaussianProcesses.html">
   第 7 章 高斯过程
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="chapter08-InterefenceEngine.html">
   第 8 章 推断引擎
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="chapter09-WheretoGoNext.html">
   第 9 章 下一步去哪儿？
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  文献阅读
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="Append-01-MCMC_Tutorial.html">
   附录 A： MCMC 推断
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Append-02-VariationalInference_Tutorial.html">
   附录 B： 变分法推断
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Append-03-GaussianProcessTutorial_01.html">
   附录 C： 高斯过程
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Append-04-BayesianNN_Tutorial.html">
   附录 D：贝叶斯神经网络
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Append-05-BayesianDeepLearning_Tutorial.html">
   附录 E：贝叶斯深度学习
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Append-06-BayesianDeepLearningPymc3.html">
   附录 F：贝叶斯深度学习编程初步
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Append-07-ModelAveraging.html">
   附录 G：模型平均
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Append-08-ModelEnsembling.html">
   附录 H：模型集成
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Append-09-BayesianOptimization.html">
   附录 J：贝叶斯优化
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Append-10-WorkFlow.html">
   附录 K：贝叶斯工作流程
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        <a class="dropdown-buttons"
            href="_sources/chapter06-MixtureModels.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download notebook file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/chapter06-MixtureModels.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.md</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/xishansnow/BayesianAnalysiswithPython2nd"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/xishansnow/BayesianAnalysiswithPython2nd/issues/new?title=Issue%20on%20page%20%2Fchapter06-MixtureModels.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/xishansnow/BayesianAnalysiswithPython2nd/master?urlpath=lab/tree/chapter06-MixtureModels.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        <a class="jupyterhub-button" href="https://datahub.berkeley.edu/hub/user-redirect/git-pull?repo=https://github.com/xishansnow/BayesianAnalysiswithPython2nd&urlpath=lab/tree/BayesianAnalysiswithPython2nd/chapter06-MixtureModels.md&branch=master"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch JupyterHub" data-toggle="tooltip"
                data-placement="left"><img class="jupyterhub-button-logo"
                    src="_static/images/logo_jupyterhub.svg"
                    alt="Interact on JupyterHub">JupyterHub</button></a>
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id2">
   6.1 混合模型
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id3">
   6.2 有限组分的混合模型 – 以高斯混合模型为例
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id4">
     6.2.1 类别分布
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id5">
     6.2.2 狄利克雷分布
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id6">
     6.2.3 混合模型的不可辨识性
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#k">
     6.2.4 如何选择
     <span class="math notranslate nohighlight">
      \(K\)
     </span>
     ?
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id7">
     6.2.5 混合模型与聚类
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id8">
   6.3 无限组分的混合模型 — 以狄利克雷过程为例
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id9">
     6.3.1 狄利克雷过程
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id10">
   6.4 连续混合模型
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id11">
     6.4.1 贝塔–二项分布
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id12">
     6.4.2 负二项分布
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#t">
     6.4.3 学生
     <span class="math notranslate nohighlight">
      \(t\)
     </span>
     分布
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id13">
   6.5 总结
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id14">
   6.6 习题
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="id1">
<h1>第 6 章 混合模型<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h1>
 <style>p{text-indent:2em;2}</style>
<p>混合已有元素是创造新东西的一种方式。在统计学中，混合模型是一种常用的建模方法。这些模型通过混合简单分布来获得复杂分布。例如，可以组合两个高斯分布来描述双峰分布，或者组合多个高斯分布来描述任意分布。虽然使用高斯分布很常见，但原则上可以混合任何想要的分布族。</p>
<p>混合模型可以用于很多不同的目的，例如可直接用于组分建模，也可以作为处理复杂分布（特别是不能用更简单分布描述的复杂分布）的有用技巧。</p>
<p>本章将学习以下内容：</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">有限混合模型</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">无限混合模型</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">连续混合模型</span></code></p></li>
</ul>
<hr class="docutils" />
<div class="section" id="id2">
<h2>6.1 混合模型<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>当总体是不同的组分的组合时，混合模型自然会出现。一个典型案例是给定成年人口的身高分布，这可以被描述为女性和男性两个亚群的混合。手写数字图像像素值的分布是一个更复杂的例子，在该问题范畴内，预期存在 10 个亚群非常合理，至少在 10 进制系统中如此！
如果我们已经知道了每个观测数据属于哪个组分，那么单独为每个组分建模是一个好主意。但当无法获得组分数量信息时，构建一个能够同时对多组分建模的新模型就派上了用场，这种新模型就是混合模型。</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>许多数据集不能用基础的概率分布来准确描述，但可以被描述为若干个基础概率分布的混合。这种假设数据来自混合分布的模型称为混合模型。</p>
</div>
<p>当建立一个混合模型时，并不一定要相信我们在数据中描述的是真实的子种群。混合模型作为一个统计技巧，可以为我们的工具箱增加灵活性。以高斯分布为例，可以用其作为许多单峰分布和对称分布的近似。但当存在多峰或不对称分布时该怎么办呢？能继续使用高斯分布来近似吗？答案是肯定的：如果使用<code class="docutils literal notranslate"><span class="pre">高斯混合模型（Guassian</span> <span class="pre">Mixture</span> <span class="pre">Model,</span> <span class="pre">GMM）</span></code>的话可以。</p>
<p>在高斯混合模型中，每个组分都是具有各自均值和标准差的高斯分布。通过组合多个高斯分布，可以为模型增加灵活性，适应更复杂的数据分布。<strong>事实上，可以通过适当的高斯组合来近似任何我们想要的分布。</strong> 所需高斯分布的确切数量取决于近似的准确性要求。事实上，本书许多章节中都在运用混合高斯分布的思想。例如：核密度估计（ <code class="docutils literal notranslate"><span class="pre">KDE</span></code> ）技巧是混合高斯思想的非贝叶斯（和非参数）实现，它假设所有数据点均来自于不同的高斯组分，
这些高斯组分的方差相等，而数据点正好位于高斯的峰值处，然后对所有单独的高斯组分进行求和，以近似数据的完整分布。</p>
<blockquote>
<div><p>提示：核密度估计（ KDE ）假设每个数据点对应一个高斯组分，因此可视为一个具有 <span class="math notranslate nohighlight">\(N\)</span> 个高斯组分的混合模型，<span class="math notranslate nohighlight">\(N\)</span> 为数据点的数量。</p>
</div></blockquote>
<p>下图展示了一个实际示例，说明了如何混合八个高斯分布来表达一个复杂分布，就像一条蟒蛇在消化一头大象。图中所有高斯都有相同方差，并且以橙色圆点为中心，这些圆点表示来自总体的样本点。如果仔细看图，你会注意到，临近数据点对应的高斯基本是一个叠加在另一个之上：</p>
<center>
<p><img alt="" src="https://gitee.com/XiShanSnow/imagebed/raw/master/images/articles/spatialPresent_20210505172616_90.webp" />
图 6.1 一个 8 组分高斯混合的例子</p>
</center>
<p>无论出于组分分析还是数学上的便利，混合模型都是一种很有用的方式，通过混合多个分布来描述数据，从而增加模型的灵活性。</p>
</div>
<div class="section" id="id3">
<h2>6.2 有限组分的混合模型 – 以高斯混合模型为例<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<p>建立混合模型的一种方法是考虑两个（含两个）以上有限分布的加权混合。这就是 <code class="docutils literal notranslate"><span class="pre">有限混合模型（Finite</span> <span class="pre">mixture</span> <span class="pre">models）</span></code> 。此时，观测数据的概率密度是所有子群组概率密度的加权和：</p>
<div class="math notranslate nohighlight">
\[
p(y \mid \theta)=\sum_{i=1}^{K} w_{i} p_{i}\left(y \mid \theta_{i}\right) \tag{式6.1}
\]</div>
<p>此处 <span class="math notranslate nohighlight">\(w_i\)</span> 是每个组分（或类）的权重，可以将 <span class="math notranslate nohighlight">\(w_i\)</span> 解释为组分 <span class="math notranslate nohighlight">\(i\)</span> 的概率，因此<span class="math notranslate nohighlight">\(w_i\)</span> 的值域为区间 [0，1] ，并且 <span class="math notranslate nohighlight">\(\sum_{i}^{K} w_{i}=1\)</span> 。</p>
<p><strong>这些组分的概率密度 <span class="math notranslate nohighlight">\(p_i(y|\theta_i)\)</span> 实际上可以是任何我们认为有用的分布，从简单的高斯（或泊松）到更复杂的分层模型（或神经网络）</strong>。根据定义，当各组分的概率密度都是高斯分布时，这个有限混合模型就是高斯混合模型。</p>
<p>有限混合模型中的 <span class="math notranslate nohighlight">\(K\)</span> 是一个有限数字，而且通常比较小。<strong>为拟合有限混合模型，需要人工提供 <span class="math notranslate nohighlight">\(K\)</span> 值，不管是事先确实已知，还是有依据地猜测</strong>。当然， <span class="math notranslate nohighlight">\(K\)</span> 值无法确切已知时，会带来如何确定最佳 <span class="math notranslate nohighlight">\(K\)</span> 值的问题，这个问题会在<code class="docutils literal notranslate"><span class="pre">第</span> <span class="pre">6.2.4</span> <span class="pre">节</span></code>讨论。</p>
<p>从概念上讲，<strong>求解混合模型就是将每个数据点适当地分配给其中一个组分，而后依据分配后的数据点，对各组分的概率密度进行建模</strong>。在概率模型中，可通过引入随机变量 <span class="math notranslate nohighlight">\(z\)</span> 来实现这一点，该变量将指示某个观测被分配给了哪个组分。由于这种变量值无法直接被观测到，因此通常被称为『隐变量』。</p>
<p>现在使用<code class="docutils literal notranslate"><span class="pre">第</span> <span class="pre">2</span> <span class="pre">章『概率编程』</span></code>中的化学漂移数据集来构建有限混合模型：</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span> <span class="k">as</span> <span class="nn">stats</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">pymc3</span> <span class="k">as</span> <span class="nn">pm</span>
<span class="kn">import</span> <span class="nn">arviz</span> <span class="k">as</span> <span class="nn">az</span>

<span class="n">az</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;arviz-darkgrid&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/chemical_shifts_theo_exp.csv&#39;</span><span class="p">)</span>
<span class="n">cs_exp</span> <span class="o">=</span> <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;exp&#39;</span><span class="p">]</span>
<span class="n">az</span><span class="o">.</span><span class="n">plot_kde</span><span class="p">(</span><span class="n">cs_exp</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">cs_exp</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">([])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>([], [])
</pre></div>
</div>
<img alt="_images/chapter06-MixtureModels_2_1.png" src="_images/chapter06-MixtureModels_2_1.png" />
</div>
</div>
<center>
<img src="https://gitee.com/XiShanSnow/imagebed/raw/master/images/articles/spatialPresent_20210505173831_56.webp" style="zoom:67%;" />
<p>图 6.2 化学漂移数据的多峰表现</p>
</center>
<p>根据图示可以看出该数据无法使用单一的高斯分布来准确描述，但通过 2~ 4 个高斯分布应该会准确很多。事实上，该数据来自大约 40 个组分，只是某些组分间有较大重叠，在图中很难分辨而已。</p>
<p>此处可以继续抛硬币实验的建模思路，但高斯混合模型的不同之处在于：</p>
<p>（1）现在有 <span class="math notranslate nohighlight">\(K\)</span> 个结果（或组分），而不是 “正、反” 两个结果。</p>
<p>（2）将用于建模二分类参数 <span class="math notranslate nohighlight">\(\theta\)</span> 的贝塔分布，调整为适合多分类的狄利克雷分布（注意：贝塔分布和狄利克雷分布均为连续型分布）；</p>
<p>（3）将用于建模二分类单次实验的伯努利分布，调整为面向多分类的类别分布；</p>
<p>（4）抛硬币问题的可观测变量就是类别本身，而高斯混合模型的可观测变量是与类别有关的其他变量，而且这些变量呈高斯分布。</p>
<blockquote>
<div><p>在之前的章节中，我们利用贝塔分布为 “正、反” 两个类别出现的概率（<span class="math notranslate nohighlight">\(\theta\)</span>、<span class="math notranslate nohighlight">\(1 - \theta\)</span>）设置了先验，利用伯努利分布为单次实验的结果变量 <span class="math notranslate nohighlight">\(y\)</span> 设置了似然，并通过采样得出后验推断。类似的，高斯混合模型先用狄利克雷分布为不同组分的概率 <span class="math notranslate nohighlight">\(p\)</span> 设置先验，用类别分布为单次实验结果变量 <span class="math notranslate nohighlight">\(z\)</span> 建模，而后用高斯分布对 <span class="math notranslate nohighlight">\(z\)</span> 组分对应的可观测变量建模。</p>
</div></blockquote>
<p>高斯混合模型的概念表达式如下：</p>
<div class="amsmath math notranslate nohighlight">
\[\begin{align*} \theta &amp;\sim \operatorname{Direchlet}(\alpha)\\ z &amp;\sim
\operatorname{Categorical}(p=\theta)\\ \mu*{i} &amp;\sim
\mathcal{N}(\mu*{\mu*i},\sigma*{\mu})\\ \sigma &amp;\sim
\operatorname{Half-Cauchy}(\sigma*{\sigma})\\ y &amp;\sim
\mathcal{N}(\mu*{z},\sigma) \end{align*}\]</div>
<p>注意：</p>
<p>（1）可观测变量（ <span class="math notranslate nohighlight">\(y\)</span> ）的似然设置</p>
<p><span class="math notranslate nohighlight">\(y\)</span> 来自于某个组分类别 <span class="math notranslate nohighlight">\(z\)</span>，其服从均值为 <span class="math notranslate nohighlight">\(\mu_{z}\)</span> 、方差为 <span class="math notranslate nohighlight">\(\sigma\)</span> 的高斯分布。根据该似然函数，模型包含的参数有：组分类别 <span class="math notranslate nohighlight">\(z\)</span>、组分均值 <span class="math notranslate nohighlight">\(\mu_{z},z=\{1,2,..,K\}\)</span>、组分方差 <span class="math notranslate nohighlight">\(\sigma\)</span> 。需要分别为这些模型参数设置先验分布。</p>
<p>（2）组分类别（ <span class="math notranslate nohighlight">\(z\)</span> ）的先验设置</p>
<p>组分类别（ <span class="math notranslate nohighlight">\(z\)</span> ）的先验设置为类别分布，类别分布的参数 <span class="math notranslate nohighlight">\(p\)</span> 为超先验参数，设定为狄利克雷分布。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>注意：类别分布是离散分布，而狄利克雷分布为连续分布，其关系类似伯努利分布与贝塔分布。</p>
</div>
<p>（3）组分均值（ <span class="math notranslate nohighlight">\(\mu_{z}\)</span> ）的先验设置</p>
<p>所有组分均值的先验设置为等方差的高斯分布。本模型在此处未采用分层模型，高斯分布的两个参数（均值和方差）均设置为常数。其中均值参数设置为样本的平均值 <span class="math notranslate nohighlight">\(\mu_{\mu_i}\)</span>，方差参数所有组分均相等，统一设置为常数 <span class="math notranslate nohighlight">\(\sigma_{\mu}\)</span> 。</p>
<p>（4）组分方差（ <span class="math notranslate nohighlight">\(\sigma\)</span> ）的先验设置</p>
<p>假设所有组分的方差均服从相同的分布，其先验设置为方差为 <span class="math notranslate nohighlight">\(\sigma_\sigma\)</span> 半柯西分布（或半高斯分布）。</p>
<div class="section" id="id4">
<h3>6.2.1 类别分布<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>类别分布是最一般的离散分布，通过指定每个可能结果的概率来参数化。下图表示类别分布的两个实例，点表示类别分布的值，而线条辅助我们掌握分布的形状：</p>
<center>
<img src="https://gitee.com/XiShanSnow/imagebed/raw/master/images/articles/spatialPresent_20210505174816_08.webp" style="zoom:67%;" />
<p>图 6.3 类别分布的示例，图中蓝色为一个三类别分布，橙色曲线为一个四类别分布。</p>
</center>
</div>
<div class="section" id="id5">
<h3>6.2.2 狄利克雷分布<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<p>狄利克雷分布乍看可能有点奇怪，因为它是一种单纯形，有点像 <span class="math notranslate nohighlight">\(n\)</span> 维的三角形：1 单纯形是一个线段；2 单纯形是一个三角形；3 单纯形是正四面体，以此类推。为什么是一个单纯形？直观上看，是因为该分布是一个长度为 <span class="math notranslate nohighlight">\(K\)</span> 的向量，其中每个元素都为正数而且所有元素之和为 1。在理解为何狄利克雷分布是贝塔分布的一般形式前，先回顾下贝塔分布的特性。前面用贝塔分布来描述二分类问题，其中之一的概率为 <span class="math notranslate nohighlight">\(p\)</span> ，另一个概率为 <span class="math notranslate nohighlight">\(1-p\)</span>
，因而可以认为贝塔分布返回长度为 2 的向量 <span class="math notranslate nohighlight">\([p, 1- p]\)</span> 。当然，实践中通常忽略 <span class="math notranslate nohighlight">\(1-p\)</span> ，因为通过 <span class="math notranslate nohighlight">\(p\)</span> 完全可以定义。此外贝塔分布也可以通过两个标量 <span class="math notranslate nohighlight">\(α\)</span> 和 <span class="math notranslate nohighlight">\(β\)</span> 来定义。</p>
<p>这些参数如何类比到狄利克雷分布中呢？先考虑最简单的狄利克雷分布，即 3 分类问题建模。此时狄利克雷分布返回一个长度为 3 的向量 <span class="math notranslate nohighlight">\([p, q, r ]\)</span>，其中 <span class="math notranslate nohighlight">\(r = 1 − (p + q)\)</span> 。也可以用 3 个标量来描述狄利克雷分布，称为 <span class="math notranslate nohighlight">\(α\)</span>、<span class="math notranslate nohighlight">\(β\)</span> 和 <span class="math notranslate nohighlight">\(γ\)</span> ，不过不便于推广到高维情形，所以统一使用长度为 <span class="math notranslate nohighlight">\(K\)</span> 的向量 <span class="math notranslate nohighlight">\(\mathbf{\alpha}\)</span> 来描述，其中 <span class="math notranslate nohighlight">\(K\)</span> 对应组分数量（可能出现的结果类型数量）。</p>
<p>可将贝塔分布和狄利克雷分布想象成某种比率的分布，为更直观地理解，下图将不同参数对应的狄利克雷分布画出来，留意图中每个三角形与参数相近的贝塔分布之间的联系。其中：</p>
<p>（1）<span class="math notranslate nohighlight">\(\mathbf{\alpha}\)</span> 值越大，说明分布越集中，<span class="math notranslate nohighlight">\(\alpha\)</span> 越小，说明分布越接近均匀分布。当 <span class="math notranslate nohighlight">\(\alpha \to \infty\)</span> 时，狄利克雷分布逐步趋近于连续分布，因此 <span class="math notranslate nohighlight">\(\mathbf{\alpha}\)</span> 也被称为聚集参数。</p>
<p>（2） <span class="math notranslate nohighlight">\(\alpha\)</span> 各维度的值越接近，分布越趋于中心化。</p>
<center>
<p><img alt="" src="https://gitee.com/XiShanSnow/imagebed/raw/master/images/articles/spatialPresent_20210505175717_a9.webp" /></p>
<p>图 6.4</p>
</center>
<p>现在对狄利克雷分布有了了解，就可以进一步掌握学习混合模型的知识。构建混合模型的一种可视化方法是将其看作是基于高斯估计模型的 <span class="math notranslate nohighlight">\(K\)</span> 面抛硬币问题，或 <span class="math notranslate nohighlight">\(K\)</span> 面掷骰子问题。用 <code class="docutils literal notranslate"><span class="pre">Kruschke</span> <span class="pre">图</span></code>可以将模型画成如下形式。</p>
<center>
<img src="https://gitee.com/XiShanSnow/imagebed/raw/master/images/articles/spatialPresent_20210505175913_df.webp" style="zoom:67%;" />
<p>图 6.5</p>
</center>
<p>图中圆角矩形框表示我们有 <span class="math notranslate nohighlight">\(K\)</span> 个组分，类别变量则决定了具体使用哪个类别来描述数据点。模型中我们假设已知这些高斯分布的均值和标准差；只需将每个点赋给一个高斯分布即可。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>在图 6.5 中，只有 <span class="math notranslate nohighlight">\(\mu_{k}\)</span> 依赖于不同的组件，而 <span class="math notranslate nohighlight">\(\sigma_\mu\)</span> 和 <span class="math notranslate nohighlight">\(\sigma_\sigma\)</span> 对所有组分都是相同的。当然，如果需要也可以更改此设置，并允许在每个组件上设置其他参数。</p>
</div>
<p>该模型（假设 <code class="docutils literal notranslate"><span class="pre">clusters=2</span></code> ）可以用 <code class="docutils literal notranslate"><span class="pre">PyMC3</span></code> 实现为：</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">clusters</span><span class="o">=</span><span class="mi">2</span>

<span class="k">with</span> <span class="n">pm</span><span class="o">.</span><span class="n">Model</span><span class="p">()</span> <span class="k">as</span> <span class="n">model_kg</span><span class="p">:</span>
    <span class="c1"># 先验p： 服从狄拉克雷分布</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Dirichlet</span> <span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">clusters</span><span class="p">))</span>
    <span class="c1"># 隐变量z： 是来自 p 的一次多类别抽样</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">cs_exp</span><span class="p">))</span>
    <span class="c1"># 各组分分别服从各自（均值，标准差为10）的高斯分布</span>
    <span class="n">means</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s1">&#39;means&#39;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">cs_exp</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">sd</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">clusters</span><span class="p">)</span>
    <span class="c1"># 均值服从半正态分布</span>
    <span class="n">sd</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">HalfNormal</span><span class="p">(</span><span class="s1">&#39;sd&#39;</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="c1"># y 服从（多组分加权的平均值，sd=10）的高斯分布</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">means</span><span class="p">[</span><span class="n">z</span><span class="p">],</span> <span class="n">sd</span><span class="o">=</span><span class="n">sd</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="n">cs_exp</span><span class="p">)</span>

    <span class="n">trace_kg</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">KeyboardInterrupt</span><span class="g g-Whitespace">                         </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">ipykernel_2944</span><span class="o">/</span><span class="mf">1412715280.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>     <span class="n">p</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Dirichlet</span> <span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">clusters</span><span class="p">))</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span>     <span class="c1"># 隐变量z： 是来自 p 的一次多类别抽样</span>
<span class="ne">----&gt; </span><span class="mi">7</span>     <span class="n">z</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">cs_exp</span><span class="p">))</span>
<span class="g g-Whitespace">      </span><span class="mi">8</span>     <span class="c1"># 各组分分别服从各自（均值，标准差为10）的高斯分布</span>
<span class="g g-Whitespace">      </span><span class="mi">9</span>     <span class="n">means</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s1">&#39;means&#39;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">cs_exp</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">sd</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">clusters</span><span class="p">)</span>

<span class="nn">/opt/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/site-packages/pymc3/distributions/distribution.py</span> in <span class="ni">__new__</span><span class="nt">(cls, name, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">120</span>         <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">121</span>             <span class="n">dist</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">dist</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">122</span>         <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">total_size</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">dims</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">123</span> 
<span class="g g-Whitespace">    </span><span class="mi">124</span>     <span class="k">def</span> <span class="nf">__getnewargs__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

<span class="nn">/opt/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/site-packages/pymc3/model.py</span> in <span class="ni">Var</span><span class="nt">(self, name, dist, data, total_size, dims)</span>
<span class="g g-Whitespace">   </span><span class="mi">1136</span>             <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="s2">&quot;transform&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1137</span>                 <span class="k">with</span> <span class="bp">self</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">1138</span>                     <span class="n">var</span> <span class="o">=</span> <span class="n">FreeRV</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">distribution</span><span class="o">=</span><span class="n">dist</span><span class="p">,</span> <span class="n">total_size</span><span class="o">=</span><span class="n">total_size</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1139</span>                 <span class="bp">self</span><span class="o">.</span><span class="n">free_RVs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1140</span>             <span class="k">else</span><span class="p">:</span>

<span class="nn">/opt/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/site-packages/pymc3/model.py</span> in <span class="ni">__init__</span><span class="nt">(self, type, owner, index, name, distribution, total_size, model)</span>
<span class="g g-Whitespace">   </span><span class="mi">1669</span>                 <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">distribution</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">distribution</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span> <span class="o">*</span> <span class="n">distribution</span><span class="o">.</span><span class="n">default</span><span class="p">()</span>
<span class="g g-Whitespace">   </span><span class="mi">1670</span>             <span class="p">)</span>
<span class="ne">-&gt; </span><span class="mi">1671</span>             <span class="bp">self</span><span class="o">.</span><span class="n">logp_elemwiset</span> <span class="o">=</span> <span class="n">distribution</span><span class="o">.</span><span class="n">logp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1672</span>             <span class="c1"># The logp might need scaling in minibatches.</span>
<span class="g g-Whitespace">   </span><span class="mi">1673</span>             <span class="c1"># This is done in `Factor`.</span>

<span class="nn">/opt/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/site-packages/pymc3/distributions/discrete.py</span> in <span class="ni">logp</span><span class="nt">(self, value)</span>
<span class="g g-Whitespace">   </span><span class="mi">1419</span>             <span class="n">a</span> <span class="o">=</span> <span class="n">tt</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">value_clip</span><span class="p">])</span>
<span class="g g-Whitespace">   </span><span class="mi">1420</span> 
<span class="ne">-&gt; </span><span class="mi">1421</span>         <span class="k">return</span> <span class="n">bound</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1422</span>             <span class="n">a</span><span class="p">,</span> <span class="n">value</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">value</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">tt</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">p_</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span> <span class="n">tt</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">p</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1423</span>         <span class="p">)</span>

<span class="nn">/opt/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/site-packages/pymc3/distributions/dist_math.py</span> in <span class="ni">bound</span><span class="nt">(logp, *conditions, **kwargs)</span>
<span class="g g-Whitespace">     </span><span class="mi">80</span>         <span class="n">alltrue</span> <span class="o">=</span> <span class="n">alltrue_scalar</span>
<span class="g g-Whitespace">     </span><span class="mi">81</span> 
<span class="ne">---&gt; </span><span class="mi">82</span>     <span class="k">return</span> <span class="n">tt</span><span class="o">.</span><span class="n">switch</span><span class="p">(</span><span class="n">alltrue</span><span class="p">(</span><span class="n">conditions</span><span class="p">),</span> <span class="n">logp</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">83</span> 
<span class="g g-Whitespace">     </span><span class="mi">84</span> 

<span class="nn">/opt/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/site-packages/pymc3/distributions/dist_math.py</span> in <span class="ni">alltrue_elemwise</span><span class="nt">(vals)</span>
<span class="g g-Whitespace">     </span><span class="mi">86</span>     <span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span>
<span class="g g-Whitespace">     </span><span class="mi">87</span>     <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">:</span>
<span class="ne">---&gt; </span><span class="mi">88</span>         <span class="n">ret</span> <span class="o">=</span> <span class="n">ret</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="n">c</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">89</span>     <span class="k">return</span> <span class="n">ret</span>
<span class="g g-Whitespace">     </span><span class="mi">90</span> 

<span class="nn">/opt/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/site-packages/theano/tensor/var.py</span> in <span class="ni">__mul__</span><span class="nt">(self, other)</span>
<span class="g g-Whitespace">    </span><span class="mi">126</span>         <span class="c1"># and the return value in that case</span>
<span class="g g-Whitespace">    </span><span class="mi">127</span>         <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">128</span>             <span class="k">return</span> <span class="n">theano</span><span class="o">.</span><span class="n">tensor</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">129</span>         <span class="k">except</span> <span class="p">(</span><span class="ne">NotImplementedError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">130</span>             <span class="k">return</span> <span class="bp">NotImplemented</span>

<span class="nn">/opt/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/site-packages/theano/graph/op.py</span> in <span class="ni">__call__</span><span class="nt">(self, *inputs, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">251</span> 
<span class="g g-Whitespace">    </span><span class="mi">252</span>         <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">compute_test_value</span> <span class="o">!=</span> <span class="s2">&quot;off&quot;</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">253</span>             <span class="n">compute_test_value</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">254</span> 
<span class="g g-Whitespace">    </span><span class="mi">255</span>         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

<span class="nn">/opt/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/site-packages/theano/graph/op.py</span> in <span class="ni">compute_test_value</span><span class="nt">(node)</span>
<span class="g g-Whitespace">    </span><span class="mi">124</span> 
<span class="g g-Whitespace">    </span><span class="mi">125</span>     <span class="c1"># Create a thunk that performs the computation</span>
<span class="ne">--&gt; </span><span class="mi">126</span>     <span class="n">thunk</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">make_thunk</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">storage_map</span><span class="p">,</span> <span class="n">compute_map</span><span class="p">,</span> <span class="n">no_recycling</span><span class="o">=</span><span class="p">[])</span>
<span class="g g-Whitespace">    </span><span class="mi">127</span>     <span class="n">thunk</span><span class="o">.</span><span class="n">inputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">storage_map</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">inputs</span><span class="p">]</span>
<span class="g g-Whitespace">    </span><span class="mi">128</span>     <span class="n">thunk</span><span class="o">.</span><span class="n">outputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">storage_map</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">outputs</span><span class="p">]</span>

<span class="nn">/opt/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/site-packages/theano/graph/op.py</span> in <span class="ni">make_thunk</span><span class="nt">(self, node, storage_map, compute_map, no_recycling, impl)</span>
<span class="g g-Whitespace">    </span><span class="mi">632</span>             <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">633</span>             <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">634</span>                 <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_c_thunk</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">storage_map</span><span class="p">,</span> <span class="n">compute_map</span><span class="p">,</span> <span class="n">no_recycling</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">635</span>             <span class="k">except</span> <span class="p">(</span><span class="ne">NotImplementedError</span><span class="p">,</span> <span class="n">MethodNotDefined</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">636</span>                 <span class="c1"># We requested the c code, so don&#39;t catch the error.</span>

<span class="nn">/opt/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/site-packages/theano/graph/op.py</span> in <span class="ni">make_c_thunk</span><span class="nt">(self, node, storage_map, compute_map, no_recycling)</span>
<span class="g g-Whitespace">    </span><span class="mi">598</span>                 <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Disabling C code for </span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2"> due to unsupported float16&quot;</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">599</span>                 <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;float16&quot;</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">600</span>         <span class="n">outputs</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">make_thunk</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">601</span>             <span class="n">input_storage</span><span class="o">=</span><span class="n">node_input_storage</span><span class="p">,</span> <span class="n">output_storage</span><span class="o">=</span><span class="n">node_output_storage</span>
<span class="g g-Whitespace">    </span><span class="mi">602</span>         <span class="p">)</span>

<span class="nn">/opt/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/site-packages/theano/link/c/basic.py</span> in <span class="ni">make_thunk</span><span class="nt">(self, input_storage, output_storage, storage_map)</span>
<span class="g g-Whitespace">   </span><span class="mi">1201</span>         <span class="s2">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">   </span><span class="mi">1202</span><span class="s2">         init_tasks, tasks = self.get_init_tasks()</span>
<span class="ne">-&gt; </span><span class="mi">1203</span><span class="s2">         cthunk, module, in_storage, out_storage, error_storage = self.__compile__(</span>
<span class="g g-Whitespace">   </span><span class="mi">1204</span><span class="s2">             input_storage, output_storage, storage_map</span>
<span class="g g-Whitespace">   </span><span class="mi">1205</span><span class="s2">         )</span>

<span class="nn">/opt/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/site-packages/theano/link/c/basic.py</span> in <span class="ni">__compile__</span><span class="nt">(self, input_storage, output_storage, storage_map)</span>
<span class="g g-Whitespace">   </span><span class="mi">1136</span><span class="s2">         input_storage = tuple(input_storage)</span>
<span class="g g-Whitespace">   </span><span class="mi">1137</span><span class="s2">         output_storage = tuple(output_storage)</span>
<span class="ne">-&gt; </span><span class="mi">1138</span><span class="s2">         thunk, module = self.cthunk_factory(</span>
<span class="g g-Whitespace">   </span><span class="mi">1139</span><span class="s2">             error_storage,</span>
<span class="g g-Whitespace">   </span><span class="mi">1140</span><span class="s2">             input_storage,</span>

<span class="nn">/opt/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/site-packages/theano/link/c/basic.py</span> in <span class="ni">cthunk_factory</span><span class="nt">(self, error_storage, in_storage, out_storage, storage_map)</span>
<span class="g g-Whitespace">   </span><span class="mi">1632</span><span class="s2">             for node in self.node_order:</span>
<span class="g g-Whitespace">   </span><span class="mi">1633</span><span class="s2">                 node.op.prepare_node(node, storage_map, None, &quot;c&quot;)</span>
<span class="ne">-&gt; </span><span class="mi">1634</span><span class="s2">             module = get_module_cache().module_from_key(key=key, lnk=self)</span>
<span class="g g-Whitespace">   </span><span class="mi">1635</span><span class="s2"> </span>
<span class="g g-Whitespace">   </span><span class="mi">1636</span><span class="s2">         vars = self.inputs + self.outputs + self.orphans</span>

<span class="nn">/opt/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/site-packages/theano/link/c/cmodule.py</span> in <span class="ni">module_from_key</span><span class="nt">(self, key, lnk)</span>
<span class="g g-Whitespace">   </span><span class="mi">1189</span><span class="s2">             try:</span>
<span class="g g-Whitespace">   </span><span class="mi">1190</span><span class="s2">                 location = dlimport_workdir(self.dirname)</span>
<span class="ne">-&gt; </span><span class="mi">1191</span><span class="s2">                 module = lnk.compile_cmodule(location)</span>
<span class="g g-Whitespace">   </span><span class="mi">1192</span><span class="s2">                 name = module.__file__</span>
<span class="g g-Whitespace">   </span><span class="mi">1193</span><span class="s2">                 assert name.startswith(location)</span>

<span class="nn">/opt/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/site-packages/theano/link/c/basic.py</span> in <span class="ni">compile_cmodule</span><span class="nt">(self, location)</span>
<span class="g g-Whitespace">   </span><span class="mi">1541</span><span class="s2">             try:</span>
<span class="g g-Whitespace">   </span><span class="mi">1542</span><span class="s2">                 _logger.debug(f&quot;LOCATION </span><span class="si">{location}</span><span class="s2">&quot;)</span>
<span class="ne">-&gt; </span><span class="mi">1543</span><span class="s2">                 module = c_compiler.compile_str(</span>
<span class="g g-Whitespace">   </span><span class="mi">1544</span><span class="s2">                     module_name=mod.code_hash,</span>
<span class="g g-Whitespace">   </span><span class="mi">1545</span><span class="s2">                     src_code=src_code,</span>

<span class="nn">/opt/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/site-packages/theano/link/c/cmodule.py</span> in <span class="ni">compile_str</span><span class="nt">(module_name, src_code, location, include_dirs, lib_dirs, libs, preargs, py_module, hide_symbols)</span>
<span class="g g-Whitespace">   </span><span class="mi">2494</span><span class="s2"> </span>
<span class="g g-Whitespace">   </span><span class="mi">2495</span><span class="s2">         try:</span>
<span class="ne">-&gt; </span><span class="mi">2496</span><span class="s2">             p_out = output_subprocess_Popen(cmd)</span>
<span class="g g-Whitespace">   </span><span class="mi">2497</span><span class="s2">             compile_stderr = p_out[1].decode()</span>
<span class="g g-Whitespace">   </span><span class="mi">2498</span><span class="s2">         except Exception:</span>

<span class="nn">/opt/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/site-packages/theano/utils.py</span> in <span class="ni">output_subprocess_Popen</span><span class="nt">(command, **params)</span>
<span class="g g-Whitespace">    </span><span class="mi">252</span><span class="s2">     # we need to use communicate to make sure we don&#39;t deadlock around</span>
<span class="g g-Whitespace">    </span><span class="mi">253</span><span class="s2">     # the stdout/stderr pipe.</span>
<span class="ne">--&gt; </span><span class="mi">254</span><span class="s2">     out = p.communicate()</span>
<span class="g g-Whitespace">    </span><span class="mi">255</span><span class="s2">     return out + (p.returncode,)</span>
<span class="g g-Whitespace">    </span><span class="mi">256</span><span class="s2"> </span>

<span class="nn">/opt/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/subprocess.py</span> in <span class="ni">communicate</span><span class="nt">(self, input, timeout)</span>
<span class="g g-Whitespace">   </span><span class="mi">1026</span><span class="s2"> </span>
<span class="g g-Whitespace">   </span><span class="mi">1027</span><span class="s2">             try:</span>
<span class="ne">-&gt; </span><span class="mi">1028</span><span class="s2">                 stdout, stderr = self._communicate(input, endtime, timeout)</span>
<span class="g g-Whitespace">   </span><span class="mi">1029</span><span class="s2">             except KeyboardInterrupt:</span>
<span class="g g-Whitespace">   </span><span class="mi">1030</span><span class="s2">                 # https://bugs.python.org/issue25942</span>

<span class="nn">/opt/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/subprocess.py</span> in <span class="ni">_communicate</span><span class="nt">(self, input, endtime, orig_timeout)</span>
<span class="g g-Whitespace">   </span><span class="mi">1866</span><span class="s2">                             &#39;failed to raise TimeoutExpired.&#39;)</span>
<span class="g g-Whitespace">   </span><span class="mi">1867</span><span class="s2"> </span>
<span class="ne">-&gt; </span><span class="mi">1868</span><span class="s2">                     ready = selector.select(timeout)</span>
<span class="g g-Whitespace">   </span><span class="mi">1869</span><span class="s2">                     self._check_timeout(endtime, orig_timeout, stdout, stderr)</span>
<span class="g g-Whitespace">   </span><span class="mi">1870</span><span class="s2"> </span>

<span class="nn">/opt/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/selectors.py</span> in <span class="ni">select</span><span class="nt">(self, timeout)</span>
<span class="g g-Whitespace">    </span><span class="mi">413</span><span class="s2">         ready = []</span>
<span class="g g-Whitespace">    </span><span class="mi">414</span><span class="s2">         try:</span>
<span class="ne">--&gt; </span><span class="mi">415</span><span class="s2">             fd_event_list = self._selector.poll(timeout)</span>
<span class="g g-Whitespace">    </span><span class="mi">416</span><span class="s2">         except InterruptedError:</span>
<span class="g g-Whitespace">    </span><span class="mi">417</span><span class="s2">             return ready</span>

<span class="ne">KeyboardInterrupt</span>: 
</pre></div>
</div>
</div>
</div>
<p>如果你运行这段代码，会发现非常慢，迹看起来也很糟糕。原因是，在 <code class="docutils literal notranslate"><span class="pre">model_kg</span></code> 中显式地包含了隐变量 <span class="math notranslate nohighlight">\(z\)</span> 。此时对离散变量 <span class="math notranslate nohighlight">\(z\)</span> 采样通常会导致缓慢的混合，以及对概率分布尾部的大量无效探索。解决该问题的一种方法是对模型重新参数化。</p>
<p>注意，在混合模型中，观测变量 <span class="math notranslate nohighlight">\(y\)</span> 是在隐变量 <span class="math notranslate nohighlight">\(z\)</span> 基础上的条件建模，也就是 <span class="math notranslate nohighlight">\(p(y|z,\theta)\)</span> 。可以认为隐变量 <span class="math notranslate nohighlight">\(z\)</span> 是一个可被边缘化的变量并获得 <span class="math notranslate nohighlight">\(p(y|\theta)\)</span> 。<code class="docutils literal notranslate"><span class="pre">PyMC3</span></code> 包含一个 <code class="docutils literal notranslate"><span class="pre">NormalMixture</span></code> 分布，可用于编写高斯混合模型：</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">clusters</span> <span class="o">=</span> <span class="mi">2</span>
<span class="k">with</span> <span class="n">pm</span><span class="o">.</span><span class="n">Model</span><span class="p">()</span> <span class="k">as</span> <span class="n">model_mg</span><span class="p">:</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Dirichlet</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">clusters</span><span class="p">))</span>
    <span class="n">means</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s1">&#39;means&#39;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">cs_exp</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">sd</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">clusters</span><span class="p">)</span>
    <span class="n">sd</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">HalfNormal</span><span class="p">(</span><span class="s1">&#39;sd&#39;</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">NormalMixture</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="n">p</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">means</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="n">sd</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="n">cs_exp</span><span class="p">)</span>

    <span class="n">trace_mg</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">random_seed</span><span class="o">=</span><span class="mi">123</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>使用 <code class="docutils literal notranslate"><span class="pre">ArviZ</span></code> 查看迹的效果，我们将在下一节中将其与使用 <code class="docutils literal notranslate"><span class="pre">model_mgp</span></code> 获得的迹进行比较：</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">varnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;means&#39;</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">]</span>
<span class="n">az</span><span class="o">.</span><span class="n">plot_trace</span><span class="p">(</span><span class="n">trace_mg</span><span class="p">,</span> <span class="n">varnames</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<center>
<p><img alt="" src="https://gitee.com/XiShanSnow/imagebed/raw/master/images/articles/spatialPresent_20210505180821_7d.webp" /></p>
<p>图 6.6</p>
</center>
<p>同时计算此模型的摘要，我们将在下一节中将其与使用 <code class="docutils literal notranslate"><span class="pre">model_mgp</span></code> 获得的摘要进行比较：</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">trace_mg</span><span class="p">,</span> <span class="n">varnames</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<center>
<p><img alt="" src="https://gitee.com/XiShanSnow/imagebed/raw/master/images/articles/spatialPresent_20210505180929_83.webp" /></p>
</center>
</div>
<div class="section" id="id6">
<h3>6.2.3 混合模型的不可辨识性<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<p>如果仔细查看上图，会发现有一些有趣的事情。图中是两个均值约为 47 和 57.5 的双峰分布，但使用 <code class="docutils literal notranslate"><span class="pre">az.summary</span></code> 获取摘要时，两个组分的均值几乎相等，都在 52 左右，你没法区分到底哪些参量和哪个组分对应，并且可以看到一些与『 <span class="math notranslate nohighlight">\(p\)</span> 值 』相似的东西。这在统计学上被称为<code class="docutils literal notranslate"><span class="pre">参数不可辨识</span></code>问题。</p>
<p>出现不可辨识性的主要原因是：<strong>因为同方差假设下，组分一均值为 47 ，且组分二均值为 57.5 的状况，与两者交换均值后的状况相互等价，这在混合模型中也称为标签切换问题。</strong> <code class="docutils literal notranslate"><span class="pre">第</span> <span class="pre">3</span> <span class="pre">章</span> <span class="pre">『线性回归模型』</span></code> 中，在讨论线性模型和高相关性变量时已经看到过一个参数不可辨识性的例子。</p>
<p>应尽可能定义模型以消除不可识别性。对于混合模型，至少有两种方法可以做到：</p>
<ul class="simple">
<li><p>强制对组分进行排序，例如：严格要求组分的均值按照递增顺序排列</p></li>
<li><p>使用不同的信息性先验对组分进行区分，因为如果模型参数的多个选择获得相同的似然函数，则这些参数之间是无法被辨识的。</p></li>
</ul>
<p>使用 <code class="docutils literal notranslate"><span class="pre">PyMC3</span></code> 强制对组分排序可以使用 <code class="docutils literal notranslate"><span class="pre">pm.potential()</span></code> 。<code class="docutils literal notranslate"><span class="pre">PyMC3</span></code> 中模型的<code class="docutils literal notranslate"><span class="pre">势（potential）</span></code> 是人为添加到似然中的一种加性因子，并非新的随机变量。势和似然之间的主要区别在于：<strong>势大多依据模型的约束人为来设置，不一定取决于数据，而似然肯定取决于数据</strong> 。</p>
<p>例如对上述不可辨识性问题，可通过增加势的方法来解决：</p>
<p>方法一：利用势作强制排序。如果符合指定排序，则在似然上增加一个值为 0 的势；否则，增加一个值为 <span class="math notranslate nohighlight">\(-\infty\)</span> 的势。最终结果是，模型认为违反指定排序约束的参数不可能出现。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">clusters</span> <span class="o">=</span> <span class="mi">2</span>
<span class="k">with</span> <span class="n">pm</span><span class="o">.</span><span class="n">Model</span><span class="p">()</span> <span class="k">as</span> <span class="n">model_mgp</span><span class="p">:</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Dirichlet</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">clusters</span><span class="p">))</span>
    <span class="n">means</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s1">&#39;means&#39;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">.9</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">cs_exp</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
                      <span class="n">sd</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">clusters</span><span class="p">)</span>
    <span class="n">sd</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">HalfNormal</span><span class="p">(</span><span class="s1">&#39;sd&#39;</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">order_means</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Potential</span><span class="p">(</span><span class="s1">&#39;order_means&#39;</span><span class="p">,</span>
                               <span class="n">tt</span><span class="o">.</span><span class="n">switch</span><span class="p">(</span><span class="n">means</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">means</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">NormalMixture</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="n">p</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">means</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="n">sd</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="n">cs_exp</span><span class="p">)</span>

    <span class="n">trace_mgp</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="n">random_seed</span><span class="o">=</span><span class="mi">123</span><span class="p">)</span>

    <span class="n">varnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;means&#39;</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">]</span>

<span class="n">az</span><span class="o">.</span><span class="n">plot_trace</span><span class="p">(</span><span class="n">trace_mgp</span><span class="p">,</span> <span class="n">varnames</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<center>
<p><img alt="" src="https://gitee.com/XiShanSnow/imagebed/raw/master/images/articles/spatialPresent_20210505182452_a2.webp" /></p>
<p>图 6.7</p>
</center>
<p>计算此模型的摘要：</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">trace_mgp</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<center>
<p><img alt="" src="https://gitee.com/XiShanSnow/imagebed/raw/master/images/articles/spatialPresent_20210505182535_0f.webp" /></p>
</center>
<p>方法二：利用势保证所有组分的概率都不为零，或者换句话说，混合模型中的每个组分都至少有一个观测点。可以通过给自狄利克雷分布生成的概率 <span class="math notranslate nohighlight">\(p\)</span> ，设置阈值 <span class="math notranslate nohighlight">\(min_p\)</span>（<span class="math notranslate nohighlight">\(min_p\)</span> 为某个任意的合理值，如 0.1 或 0.01 ）来实现：</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">p_min</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Potential</span><span class="p">(</span><span class="s1">&#39;p_min&#39;</span><span class="p">,</span> <span class="n">tt</span><span class="o">.</span><span class="n">switch</span><span class="p">(</span><span class="n">tt</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_p</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>如图 6.4 所示，<span class="math notranslate nohighlight">\(α\)</span> 值控制狄利克雷分布的概率密度。与 <code class="docutils literal notranslate"><span class="pre">model_mgp</span></code> 中一样，可设置为单纯形上的平坦先验。<span class="math notranslate nohighlight">\(α\)</span> 值越大意味着先验的信息性越强。经验表明，<span class="math notranslate nohighlight">\(\alpha \approx 4 或 10 \)</span> 是比较好的选择，因为这通常会导致后验分布中每个组分至少有一个数据点，并且可以减少过高估计组分数量 <span class="math notranslate nohighlight">\(K\)</span> 的机会。</p>
</div>
<div class="section" id="k">
<h3>6.2.4 如何选择 <span class="math notranslate nohighlight">\(K\)</span> ?<a class="headerlink" href="#k" title="Permalink to this headline">¶</a></h3>
<p>有限混合模型带来的问题之一是如何确定组分数量。</p>
<p>一般从相对较少的组分开始尝试，然后增加组分数量，以改进模型拟合度的评估。模型拟合度的评估可以采用 <code class="docutils literal notranslate"><span class="pre">第</span> <span class="pre">5</span> <span class="pre">章</span> <span class="pre">『模型比较』</span></code> 中介绍的方法，如：<code class="docutils literal notranslate"><span class="pre">后验预测检查</span></code>、<code class="docutils literal notranslate"><span class="pre">WAIC</span></code> 或 <code class="docutils literal notranslate"><span class="pre">LOO</span></code> 等，并基于建模师的专业知识和判断。</p>
<p>在此拟合并比较 <span class="math notranslate nohighlight">\(K=\{3,4,5,6\}\)</span> 四个模型，保存每个迹和模型以供后面分析：</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">clusters</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span>
<span class="n">models</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">traces</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">pm</span><span class="o">.</span><span class="n">Model</span><span class="p">()</span> <span class="k">as</span> <span class="n">model</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Dirichlet</span> <span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">cluster</span><span class="p">))</span>
        <span class="n">means</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s1">&#39;means&#39;</span><span class="p">,</span>
                          <span class="n">mu</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">cs_exp</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">cs_exp</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
                                         <span class="n">cluster</span><span class="p">),</span>
                          <span class="n">sd</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">cluster</span><span class="p">,</span>
                          <span class="n">transform</span><span class="o">=</span><span class="n">pm</span><span class="o">.</span><span class="n">distributions</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">ordered</span><span class="p">)</span>
        <span class="n">sd</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">HalfNormal</span><span class="p">(</span><span class="s1">&#39;sd&#39;</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">NormalMixture</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="n">p</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">means</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="n">sd</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="n">cs_exp</span><span class="p">)</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="n">tune</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">random_seed</span><span class="o">=</span><span class="mi">123</span><span class="p">)</span>
        <span class="n">traces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
        <span class="n">models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>为更好地展示 <span class="math notranslate nohighlight">\(K\)</span> 对推断的影响，可以把模型拟合的结果与 <code class="docutils literal notranslate"><span class="pre">az.plot_kde</span></code> （内置 KDE 模型）进行比较，并且绘制混合模型的高斯组分图：</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">cs_exp</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">cs_exp</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mi">200</span><span class="p">)</span>
<span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">trace_x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">traces</span><span class="p">):</span>
    <span class="n">x_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">]</span> <span class="o">*</span> <span class="n">clusters</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">50</span><span class="p">):</span>
        <span class="n">i_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">trace_x</span><span class="p">))</span>
        <span class="n">means_y</span> <span class="o">=</span> <span class="n">trace_x</span><span class="p">[</span><span class="s1">&#39;means&#39;</span><span class="p">][</span><span class="n">i_</span><span class="p">]</span>
        <span class="n">p_y</span> <span class="o">=</span> <span class="n">trace_x</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">][</span><span class="n">i_</span><span class="p">]</span>
        <span class="n">sd</span> <span class="o">=</span> <span class="n">trace_x</span><span class="p">[</span><span class="s1">&#39;sd&#39;</span><span class="p">][</span><span class="n">i_</span><span class="p">]</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">means_y</span><span class="p">,</span> <span class="n">sd</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dist</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x_</span><span class="p">)</span> <span class="o">*</span> <span class="n">p_y</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;C0&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="n">means_y</span> <span class="o">=</span> <span class="n">trace_x</span><span class="p">[</span><span class="s1">&#39;means&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">p_y</span> <span class="o">=</span> <span class="n">trace_x</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">sd</span> <span class="o">=</span> <span class="n">trace_x</span><span class="p">[</span><span class="s1">&#39;sd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">means_y</span><span class="p">,</span> <span class="n">sd</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dist</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x_</span><span class="p">)</span> <span class="o">*</span> <span class="n">p_y</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;C0&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x_</span><span class="p">)</span> <span class="o">*</span> <span class="n">p_y</span><span class="p">,</span> <span class="s1">&#39;k--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
    <span class="n">az</span><span class="o">.</span><span class="n">plot_kde</span><span class="p">(</span><span class="n">cs_exp</span><span class="p">,</span> <span class="n">plot_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;linewidth&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="p">:</span><span class="s1">&#39;k&#39;</span><span class="p">},</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;K = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">clusters</span><span class="p">[</span><span class="n">idx</span><span class="p">]))</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<center>
<p><img alt="" src="https://gitee.com/XiShanSnow/imagebed/raw/master/images/articles/spatialPresent_20210505190548_b1.webp" /></p>
<p>图 6.8</p>
</center>
<p>上图显示了概率密度图，黑色实线为基于观测数据的 KDE 结果，蓝实线为拟合均值线，半透明的蓝色线为来自后验的采样。不同数量的高斯组分用黑色虚线表示。图中 <span class="math notranslate nohighlight">\(K=3\)</span> 似乎太低了，而 4、5 或 6 可能是更好的选择。</p>
<p>注意：高斯混合模型提示存在两个明显峰值（在 55-60 左右），而 KDE 的峰值则不那么明显。这并非因为高斯混合模型拟合效果不好，而是因为 KDE 会自动调整以提供更平滑的曲线。</p>
<p>你也可以尝试使用直方图代替 KDE。如<code class="docutils literal notranslate"><span class="pre">第</span> <span class="pre">5</span> <span class="pre">章</span> <span class="pre">『模型比较</span></code> 中讨论的，可尝试绘制感兴趣量的后验预测图，并计算贝叶斯 <span class="math notranslate nohighlight">\(p\)</span> 值。下图显示了此类计算和可视化的示例：</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ppc_mm</span> <span class="o">=</span> <span class="p">[</span><span class="n">pm</span><span class="o">.</span><span class="n">sample_posterior_predictive</span><span class="p">(</span><span class="n">traces</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
          <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)]</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">iqr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mi">75</span><span class="p">,</span> <span class="mi">25</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="n">a</span><span class="p">))</span>
<span class="n">T_obs</span> <span class="o">=</span> <span class="n">iqr</span><span class="p">(</span><span class="n">cs_exp</span><span class="p">)</span>
<span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">d_sim</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ppc_mm</span><span class="p">):</span>
    <span class="n">T_sim</span> <span class="o">=</span> <span class="n">iqr</span><span class="p">(</span><span class="n">d_sim</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">][:</span><span class="mi">100</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">p_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">T_sim</span> <span class="o">&gt;=</span> <span class="n">T_obs</span><span class="p">)</span>
    <span class="n">az</span><span class="o">.</span><span class="n">plot_kde</span><span class="p">(</span><span class="n">T_sim</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">T_obs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;K = </span><span class="si">{</span><span class="n">clusters</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="si">}</span><span class="s1"> </span><span class="se">\n</span><span class="s1"> p-value </span><span class="si">{</span><span class="n">p_value</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
</pre></div>
</div>
</div>
</div>
<center>
<p><img alt="" src="https://gitee.com/XiShanSnow/imagebed/raw/master/images/articles/spatialPresent_20210505190939_5f.webp" /></p>
<p>图 6.9</p>
</center>
<p>从图 6.9 可以看出，<span class="math notranslate nohighlight">\(K=6\)</span> 是一个很好的选择，其贝叶斯 <span class="math notranslate nohighlight">\(p\)</span> 值非常接近 0.5。正如在下面表格和图 6.10 中看到的，<code class="docutils literal notranslate"><span class="pre">WAIC</span></code> 也将 <span class="math notranslate nohighlight">\(K=6\)</span> 评为更好的模型：</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">comp</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">clusters</span><span class="p">,</span> <span class="n">traces</span><span class="p">)),</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;BB-pseudo-BMA&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<center>
<p><img alt="" src="https://gitee.com/XiShanSnow/imagebed/raw/master/images/articles/spatialPresent_20210505191135_11.webp" /></p>
</center>
<p>大多数情况下看图比看表容易得多，所以让我们画一个对比图。如下图所示，虽然 6 组分模型的 <code class="docutils literal notranslate"><span class="pre">WAIC</span></code> 比其他模型低，但当考虑估计标准误差时存在相当大的重叠，特别是对 5 组分模型：</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">plot_compare</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<center>
<p><img alt="" src="https://gitee.com/XiShanSnow/imagebed/raw/master/images/articles/spatialPresent_20210505191504_15.webp" /></p>
<p>图 6.10</p>
</center>
</div>
<div class="section" id="id7">
<h3>6.2.5 混合模型与聚类<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<p>混合模型与聚类概念不同，需要加以区别。聚类是非监督统计或非监督机器学习任务家族的一部分，和分类有些相似，但区别在于不知道数据的正确标签，因此要稍微困难一些！</p>
<p>聚类的目的是对数据进行分组，其方式是使给定组中的数据点彼此之间的距离，相较其他组中的数据点更近。通常把这些组称为簇。可以通过许多方式计算数据点之间的接近程度。例如，欧几里德距离等。如果采用概率路径作为接近程度的度量，那么混合模型自然就成为解决聚类任务的一个候选方案。</p>
<p>使用概率模型执行的聚类任务，通常被称为『基于模型的聚类』。概率模型会计算每个数据点属于每个簇的概率，形成软聚类（即数据点属于每个簇的概率是 0 到 1 之间的概率值，所有簇的概率之和为 1），而不是硬聚类（数据点属于每个簇的概率为 0 或 1）。通常概率模型会引入一些规则或决策边界将软聚类变成硬聚类，例如： Logistic 回归分类方法使用 0.5 作为默认决策边界实施二分类。当然，最自然的考虑是将数据点分配给概率值最高的那个簇。</p>
<p>总而言之，当人们谈论 “聚类” 时，通常指如何对数据进行分组，而当人们谈论 “混合模型” 时，通常指如何用简单分布的混合来近似复杂的分布。混合模型的目的不只是为了识别不同组分，更多时候是为了具有能够灵活描述数据的方法。</p>
</div>
</div>
<div class="section" id="id8">
<h2>6.3 无限组分的混合模型 — 以狄利克雷过程为例<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h2>
<p>对于某些问题，组分数量可预先知道（例如：手写数字只可能有 10 类）；有时组分数量可以有较好的猜测（例如：知道蝴蝶花样本来自一个只有三种蝴蝶花生长的地区）；即使在不能确定组分数量时，也可通过模型比较来人为确定组分数量。但是，还有一类问题并不希望提前选择组分数量，而是希望能够从数据中估计出这个数字，此类问题的贝叶斯解与狄利克雷过程过程有关。</p>
<div class="section" id="id9">
<h3>6.3.1 狄利克雷过程<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h3>
<p>到目前为止，我们介绍的所有模型都是<code class="docutils literal notranslate"><span class="pre">参数化模型</span></code>，通常具有固定数量的参数；事实上还有一类比较常用的模型：<code class="docutils literal notranslate"><span class="pre">非参数模型</span></code>（准确地说应当是<code class="docutils literal notranslate"><span class="pre">非固定数量参数模型</span></code>）。非参数模型是理论上具有无限多参数的模型，实践中会以某种方式让其从理论上无限个参数收缩到某个有限数量，换言之，用数据自动判定实际参数数量，因此非参数模型非常灵活。</p>
<p>本书将介绍两类比较重要的非参数模型：高斯过程（将在<code class="docutils literal notranslate"><span class="pre">第</span> <span class="pre">7</span> <span class="pre">章</span> <span class="pre">『高斯过程』</span></code>中介绍）和狄利克雷过程。</p>
<p><strong>狄利克雷分布是贝塔分布的高维推广，而狄利克雷过程是狄利克雷分布的无限维推广</strong>。狄利克雷分布是在概率空间上的分布（其单次采样的结果是概率空间中的一个概率值向量），而狄利克雷过程是在概率分布空间上的分布（即分布的分布，其单次采样的结果为一个分布）。对于有限混合模型，可以使用狄利克雷分布为固定数量组分的模型设置先验；而对于无限混合模型，则是采用狄利克雷过程为非固定数量组分的模型设置先验，甚至可以将狄利克雷过程视为从概率分布的先验中采样的一种方法。</p>
<p>在进入实际的无限混合模型前，先讨论一下狄利克雷过程的一些细节。狄利克雷过程的形式定义有些复杂，此处仅介绍一些狄利克雷过程的属性，这些属性有助于理解狄利克雷过程在混合模型建模中的作用：</p>
<ul class="simple">
<li><p>狄利克雷过程是一种概率分布的分布，而不是像高斯分布那样的实数分布。</p></li>
<li><p>狄利克雷过程由一个基础分布 <span class="math notranslate nohighlight">\(\mathcal{H}\)</span> 和称为聚集参数的正实数 <span class="math notranslate nohighlight">\(\alpha\)</span> 指定（类似于狄利克雷分布中的聚集参数）。</p></li>
<li><p><span class="math notranslate nohighlight">\(\mathcal{H}\)</span> 是狄利克雷过程的期望，这意味着狄利克雷过程会在 <span class="math notranslate nohighlight">\(\mathcal{H}\)</span> 周围生成分布（类似于高斯分布在平均值附近分布）</p></li>
<li><p>随着 <span class="math notranslate nohighlight">\(\alpha\)</span> 增长，实现变得越来越不集中。</p></li>
<li><p>实践中，狄利克雷过程生成的基本都是离散分布。</p></li>
<li><p>在 <span class="math notranslate nohighlight">\(\alpha \to \infty\)</span> 时，狄利克雷过程的实现等于基础分布 <span class="math notranslate nohighlight">\(\mathcal{H}\)</span> 。也就是说，如果基础分布是连续的，则狄利克雷过程最终趋于生成连续分布。但由于 <span class="math notranslate nohighlight">\(\alpha\)</span> 几乎总是有限数字，因此从狄利克雷过程产生的分布几乎肯定是离散分布。</p></li>
</ul>
<p>为使这些属性更加具象，让我们再看一看图 6.3 中的类别分布。可以通过指示 <span class="math notranslate nohighlight">\(x\)</span> 轴上的位置和 <span class="math notranslate nohighlight">\(y\)</span> 轴上的高度来完全指定这种分布。对于类别分布，<span class="math notranslate nohighlight">\(x\)</span> 轴上的位置被限制为非负整数，而且高度之和必须为 <span class="math notranslate nohighlight">\(1\)</span>。现在保留后一个限制，但放宽前一个限制。为了生成<span class="math notranslate nohighlight">\(x\)</span> 轴上的位置，可以从某个基础分布中进行采样。原则上基础分布可以是任何分布，但它决定了 <span class="math notranslate nohighlight">\(x\)</span> 轴上位置的取值范围，例如：如果选择高斯分布，位置原则上可以是实轴上的
任何值；如果选择贝塔分布，位置将被限制在区间 [0，1] 内；如果选择泊松分布，则位置将被限制在非负整数{0，1，2，…}。</p>
<p>如何选择 <span class="math notranslate nohighlight">\(y\)</span> 轴上的值呢？我们遵循一个被称为折棍过程的 Gedanken 实验。假设有一根长度为 1 的棍子，我们把它一分为二（不一定相等）；把一部分放在一边，把另一部分一分为二；然后一直这样做，直到永远。由于实践中无法真正无限地重复这个过程，所以将其截断为某个预定义的值 <span class="math notranslate nohighlight">\(K\)</span> ，但大体上是成立的。为控制折棍过程，我们使用了一个参数 <span class="math notranslate nohighlight">\(α\)</span> 。随着 <span class="math notranslate nohighlight">\(α\)</span> 值的增加，把棍子分的越来越小。也就是，在 <span class="math notranslate nohighlight">\(lim_{\alpha \to 0}\)</span> 时
，不会折断棍子；当 <span class="math notranslate nohighlight">\(lim_{\alpha \to \infty}\)</span> 时，将棍子折断成无限个碎片。图 6.11 显示了狄利克雷过程的四次对应不同 <span class="math notranslate nohighlight">\(\alpha\)</span> 值的抽样。稍后我将解释代码，现在先重点了解此示例有关狄利克雷过程的信息：</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">stick_breaking_truncated</span><span class="p">(</span><span class="n">α</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">K</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Truncated stick-breaking process view of a 狄利克雷过程</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    α : float</span>
<span class="sd">        concentration parameter</span>
<span class="sd">    H : scipy distribution</span>
<span class="sd">        Base distribution</span>
<span class="sd">    K : int</span>
<span class="sd">        number of components</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    locs : array</span>
<span class="sd">        locations</span>
<span class="sd">    w : array</span>
<span class="sd">    probabilities</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">βs</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">beta</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">α</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">K</span><span class="p">)</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">K</span><span class="p">)</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">βs</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(([</span><span class="mf">1.</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">cumprod</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">βs</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])))</span>
    <span class="n">locs</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">K</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">locs</span><span class="p">,</span> <span class="n">w</span>

<span class="c1"># Parameters 狄利克雷过程</span>
<span class="n">K</span> <span class="o">=</span> <span class="mi">500</span>
<span class="n">H</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span>
<span class="n">alphas</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1000</span><span class="p">]</span>
<span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
<span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">α</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">alphas</span><span class="p">):</span>
    <span class="n">locs</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">stick_breaking_truncated</span><span class="p">(</span><span class="n">α</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">locs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C0&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;α = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">α</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<center>
<p><img alt="" src="https://gitee.com/XiShanSnow/imagebed/raw/master/images/articles/spatialPresent_20210505193131_69.webp" /></p>
<p>图 6.11</p>
</center>
<p>从图 6.11 可以看出，狄利克雷过程是一个离散分布。当 <span class="math notranslate nohighlight">\(α\)</span> 增加时，可以得到更宽的分布和更小的棍子，注意 <span class="math notranslate nohighlight">\(y\)</span> 轴比例上的变化，并记住总长度固定为 1。基础分布控制位置，因为位置是从基础分布中采样的。可以从图 6.11 中看到，随着 <span class="math notranslate nohighlight">\(α\)</span> 增加，狄利克雷过程的分布形状越来越接近基础分布 <span class="math notranslate nohighlight">\(\mathcal{H}\)</span> ，从中可以看出，在 <span class="math notranslate nohighlight">\(lim_{\alpha \to \infty}\)</span> 时，应该能够精确得到基础分布。</p>
<blockquote>
<div><p>可以将狄利克雷过程视为随机分布 <span class="math notranslate nohighlight">\(f\)</span> 上的先验分布，其中基础分布是预期的 <span class="math notranslate nohighlight">\(f\)</span>，聚集参数表示对先验猜测的信心。</p>
</div></blockquote>
<p>图 6.1 表明，如果在每个数据点上放置一个高斯分布，然后将所有高斯分布相加，则可以近似计算数据的分布。我们可以使用狄利克雷过程做类似的事情，但不是将高斯放在每个数据点的顶部，我们可以在狄利克雷过程实现中的每个子棒位置上放置一个高斯，然后根据子棒长度对该高斯进行缩放或加权。此过程提供了无限高斯混合模型的一般方案。也可以用其他分布代替高斯分布，这样就有了一个无限混合模型的通用方案。图 6.12 显示了使用拉普拉斯分布实现混合模型的一个例子。作者随意选择拉普拉斯分布是为了强化 “不局限于高斯混合模型” 这一思想：</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">α</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">H</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span>
<span class="n">K</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">250</span><span class="p">)</span>
<span class="n">x_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">]</span> <span class="o">*</span> <span class="n">K</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
<span class="n">locs</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">stick_breaking_truncated</span><span class="p">(</span><span class="n">α</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span>
<span class="n">dist</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">laplace</span><span class="p">(</span><span class="n">locs</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dist</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x_</span><span class="p">)</span> <span class="o">*</span> <span class="n">w</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;C0&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x_</span><span class="p">)</span> <span class="o">*</span> <span class="n">w</span><span class="p">,</span> <span class="s1">&#39;k--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">([])</span>
</pre></div>
</div>
</div>
</div>
<center>
<p><img alt="" src="https://gitee.com/XiShanSnow/imagebed/raw/master/images/articles/spatialPresent_20210505193226_8a.webp" /></p>
<p>图 6.12</p>
</center>
<p>希望您在这一点上能对狄利克雷过程有一个很好的直觉。目前，唯一缺少的细节是对函数 <code class="docutils literal notranslate"><span class="pre">stick_break_truncated</span></code> 的理解。数学上狄利克雷过程的折棍过程视图可用以下公式表示：</p>
<div class="math notranslate nohighlight">
\[
 \sum_{k=1}^{\infty} w_{k} \cdot \delta_{\theta_{k}}(\theta)=f(\theta) \sim D P(\alpha, H) \tag{式6.2} 
\]</div>
<p>其中：</p>
<p><span class="math notranslate nohighlight">\( \delta*{\theta*{k}}(\theta) \)</span> 是指示函数，它只在 <span class="math notranslate nohighlight">\(\theta=\theta_{k}\)</span> 时为 1，即 <span class="math notranslate nohighlight">\( \delta*{\theta*{k}}\left(\theta\_{k}\right) = 1\)</span>, 其他情况均为 0，它表示了从基础分布 <span class="math notranslate nohighlight">\(\mathcal{H}\)</span> 中进行采样的位置。</p>
<p>概率 <span class="math notranslate nohighlight">\(w_{k}\)</span> 定义为：</p>
<div class="math notranslate nohighlight">
\[
w_{k}=\beta_{k}^{\prime} \cdot \prod_{i=1}^{k-1}\left(1-\beta_{i}^{\prime}\right) \tag{式6.3}  
\]</div>
<p>其中：</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(w_{k}\)</span> 代表子棍的长度</p></li>
<li><p><span class="math notranslate nohighlight">\(\prod_{i=1}^{k-1}\left(1-\beta_{i}^{\prime}\right)\)</span> 是剩余那部分需要一直折下去的长度</p></li>
<li><p><span class="math notranslate nohighlight">\(\beta_{k}^{\prime}\)</span> 指示如何折剩余的部分</p></li>
<li><p><span class="math notranslate nohighlight">\(\beta_{k}^{\prime} \sim \operatorname{Beta}(1, \alpha)\)</span>, 从中可看出：当 <span class="math notranslate nohighlight">\(\alpha\)</span> 增长时 <span class="math notranslate nohighlight">\(\beta_{k}^{\prime}\)</span> 平均将会变小</p></li>
</ul>
<p>现在可以尝试在 <code class="docutils literal notranslate"><span class="pre">PyMC3</span></code> 中实现狄利克雷过程了。首先定义一个使用 <code class="docutils literal notranslate"><span class="pre">PyMC3</span></code> 的 <code class="docutils literal notranslate"><span class="pre">stick_breaking</span></code> 函数：</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">N</span> <span class="o">=</span> <span class="n">cs_exp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">K</span> <span class="o">=</span> <span class="mi">20</span>

<span class="k">def</span> <span class="nf">stick_breaking</span><span class="p">(</span><span class="n">α</span><span class="p">):</span>
    <span class="n">β</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Beta</span><span class="p">(</span><span class="s1">&#39;β&#39;</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="n">α</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">K</span><span class="p">)</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">β</span> <span class="o">*</span> <span class="n">pm</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([[</span><span class="mf">1.</span><span class="p">],</span>
                                <span class="n">tt</span><span class="o">.</span><span class="n">extra_ops</span><span class="o">.</span><span class="n">cumprod</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">β</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
    <span class="k">return</span> <span class="n">w</span>
</pre></div>
</div>
</div>
</div>
<p>必须为 <span class="math notranslate nohighlight">\(\alpha\)</span> 定义一个先验。一种常见的选择是伽马分布：</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">pm</span><span class="o">.</span><span class="n">Model</span><span class="p">()</span> <span class="k">as</span> <span class="n">model</span><span class="p">:</span>
    <span class="n">α</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Gamma</span><span class="p">(</span><span class="s1">&#39;α&#39;</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Deterministic</span><span class="p">(</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">stick_breaking</span><span class="p">(</span><span class="n">α</span><span class="p">))</span>
    <span class="n">means</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s1">&#39;means&#39;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">cs_exp</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">sd</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">K</span><span class="p">)</span>
    <span class="n">sd</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">HalfNormal</span><span class="p">(</span><span class="s1">&#39;sd&#39;</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">K</span><span class="p">)</span>
    <span class="n">obs</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">NormalMixture</span><span class="p">(</span><span class="s1">&#39;obs&#39;</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">means</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="n">sd</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="n">cs_exp</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="n">trace</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="n">tune</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">nuts_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;target_accept&#39;</span><span class="p">:</span><span class="mf">0.9</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<center>
<p><img alt="" src="https://gitee.com/XiShanSnow/imagebed/raw/master/images/articles/spatialPresent_20210505194120_60.webp" /></p>
<p>图 6.13</p>
</center>
<p>从图 6.13 可以看出，<span class="math notranslate nohighlight">\(\alpha\)</span> 的值相当低，这表明需要一些组分来描述数据。</p>
<p>因为我们是通过折棍过程来近似无穷大的狄利克雷过程，所以检查截断值（在本例中 <span class="math notranslate nohighlight">\(K=20\)</span> ）没有引入任何偏差很重要。要做到这一点，可以绘制每个组分的平均权重。为安全起见，应该有几个权重可以忽略不计的组分，否则就必须增加截断值。</p>
<p>图 6.14 是一个例子。从图中可以看出，只有前面几个组分比较重要，因此可以确信所选上限值 <span class="math notranslate nohighlight">\(K=20\)</span> 对于此模型和数据已经足够：</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plot_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">K</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">plot_w</span><span class="p">,</span> <span class="n">trace</span><span class="p">[</span><span class="s1">&#39;w&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;o-&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">plot_w</span><span class="p">,</span> <span class="n">plot_w</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Component&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Average weight&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<center>
<p><img alt="" src="https://gitee.com/XiShanSnow/imagebed/raw/master/images/articles/spatialPresent_20210505194313_98.webp" /></p>
<p>图 6.14</p>
</center>
<p>图 6.15 显示了使用狄利克雷过程模型估计的平均密度曲线（黑色）以及反映估计中不确定性的后验曲线样本（灰色）。与图 6.2 和图 6.8 中的 KDE 相比，该模型的密度也不那么平滑：</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">exp</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">cs</span><span class="o">.</span><span class="n">exp</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
<span class="n">post_pdf_contribs</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_3d</span><span class="p">(</span><span class="n">x_plot</span><span class="p">),</span>
                                   <span class="n">trace</span><span class="p">[</span><span class="s1">&#39;means&#39;</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:],</span>
                                   <span class="n">trace</span><span class="p">[</span><span class="s1">&#39;sd&#39;</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:])</span>
<span class="n">post_pdfs</span> <span class="o">=</span> <span class="p">(</span><span class="n">trace</span><span class="p">[</span><span class="s1">&#39;w&#39;</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span>
             <span class="n">post_pdf_contribs</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">cs_exp</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_plot</span><span class="p">,</span> <span class="n">post_pdfs</span><span class="p">[::</span><span class="mi">100</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;0.5&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_plot</span><span class="p">,</span> <span class="n">post_pdfs</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">([])</span>
</pre></div>
</div>
</div>
</div>
<center>
<p><img alt="" src="https://gitee.com/XiShanSnow/imagebed/raw/master/images/articles/spatialPresent_20210505194356_42.webp" /></p>
<p>图 6.15</p>
</center>
</div>
</div>
<div class="section" id="id10">
<h2>6.4 连续混合模型<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h2>
<p>本章虽然重点关注了离散型变量的混合模型，但其实也可以有连续型变量的混合模型。事实上我们已经接触过其中一部分，例如 <code class="docutils literal notranslate"><span class="pre">第</span> <span class="pre">4</span> <span class="pre">章</span> <span class="pre">『广义线性模型』</span></code> 中提到的零膨胀泊松分布，该分布由一个泊松分布和一个零生成过程混合而成。另外一个例子是稳健 Logistic 回归分类模型，该模型由一个 Logistic 回归和一个随机猜测混合而成，其中参数 <span class="math notranslate nohighlight">\(π\)</span> 不再是一个开关，而更像是一个球形把手，控制着 Logistic 回归和随机猜测混合的比例，只有当 <span class="math notranslate nohighlight">\(π\)</span> 为 0 或 1 时，才会得到完全的随机结果或者完全的 Logistic 回归结果。</p>
<p>层次模型也可视为连续混合模型，其中每个组的参数来自于上层的连续分布。更具体点，假设要对几个不同的组做线性回归，可以假设每个组都有独立的斜率或者所有组共享相同的斜率。 此外，除了将问题看作这两种极限情况，还可以构建一个多层模型，对这些极限值构建一个连续混合模型，此时极限值仅是分层模型中的一些特例而已。</p>
<div class="section" id="id11">
<h3>6.4.1 贝塔–二项分布<a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h3>
<p>贝塔-二项分布是一个离散分布，通常用来描述 <span class="math notranslate nohighlight">\(n\)</span> 次伯努利实验中成功的次数 <span class="math notranslate nohighlight">\(y\)</span> ，其中每次实验成功的概率 <span class="math notranslate nohighlight">\(p\)</span> 未知，并且假设其服从参数为 <span class="math notranslate nohighlight">\(α\)</span> 和 <span class="math notranslate nohighlight">\(β\)</span> 的贝塔分布，对应的数学形式如下：</p>
<div class="math notranslate nohighlight">
\[
\operatorname{BetaBinonial}(y \mid n, \alpha, \beta)=\int_{0}^{1} \operatorname{Bin}(y \mid p, n) \operatorname{Beta}(p \mid \alpha, \beta) d p \tag{式6.4} 
\]</div>
<p>也就是说，为了找到观测到结果 <span class="math notranslate nohighlight">\(y\)</span> 的概率，我们遍历所有可能的（连续的）<span class="math notranslate nohighlight">\(p\)</span> 值然后求平均。因此，贝塔-二项分布也可以看作是连续混合模型。如果你觉得贝塔-二项分布听起来很熟悉，那一定是因为你对本书前两章学得很认真！在抛硬币的问题中，我们用到了该模型，尽管当时显式地使用了一个贝塔分布和一个二项分布，你也可以直接使用贝塔-二项分布。</p>
</div>
<div class="section" id="id12">
<h3>6.4.2 负二项分布<a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h3>
<p>类似的，还有负二项分布。可以将其看作是一个连续混合的伽马–泊松分布，也就是将一个来自伽马分布的值作为泊松分布的参数，然后对泊松分布连同伽马分布求均值（积分）。该分布常用来解决计数型数据中的一个常见问题：过度离散。</p>
<p>假设你用一个泊松分布来对计数型数据建模，然后你意识到数据中的方差超出了模型方差（使用泊松分布的一个问题是，其均值与方差存在联系，事实上是用同一个参数描述的），那么解决该问题的一个办法是将数据看作是（连续的）泊松分布的混合，其中的泊松分布的参数来自于一个伽马分布，从而很自然地用到了负二项分布。使用混合分布之后，我们的模型有了更好的灵活性，并且能够更好地适应从数据中观测到的均值和方差。</p>
<p>贝塔-二项分布和负二项分布都可以用作线性模型的一部分，而且也都有零膨胀的版本，此外二者都已经在 <code class="docutils literal notranslate"><span class="pre">PyMC3</span></code> 中实现了。</p>
</div>
<div class="section" id="t">
<h3>6.4.3 学生 <span class="math notranslate nohighlight">\(t\)</span> 分布<a class="headerlink" href="#t" title="Permalink to this headline">¶</a></h3>
<p>前面我们介绍了学生 <span class="math notranslate nohighlight">\(t\)</span> 分布是一种更稳健的高斯分布。从下面的数学表达式可以看到，<span class="math notranslate nohighlight">\(t\)</span> 分布同样可以被视为连续混合模型：</p>
<div class="math notranslate nohighlight">
\[
t_{\nu}(y \mid \mu, \sigma)=\int_{0}^{\infty} N(y \mid \mu, \sigma) \operatorname{Inv} \chi^{2}(\sigma \mid \nu) d \nu \tag{式6.5} 
\]</div>
<p>注意，这个表达式与前面的负二项分布的表达式很像，不过这里是参数为 <span class="math notranslate nohighlight">\(\mu\)</span> 和 <span class="math notranslate nohighlight">\(σ\)</span> 的正态分布以及从参数为 <span class="math notranslate nohighlight">\(v\)</span> 的 <span class="math notranslate nohighlight">\(Invχ^2\)</span> 分布中采样得到的 <span class="math notranslate nohighlight">\(σ\)</span>，也就是自由度，通常更倾向于称之为正态参数。这里参数 <span class="math notranslate nohighlight">\(v\)</span> 和贝塔-二项分布里的参数 <span class="math notranslate nohighlight">\(p\)</span> 概念上相似，等价于有限混合模型中的隐变量 <span class="math notranslate nohighlight">\(z\)</span> 。</p>
<p>对于有限混合模型来说，很多时候可以在推断之前先对隐变量 <span class="math notranslate nohighlight">\(z\)</span> 做边缘化处理，从而得到一个更简单的模型，正如前面边缘混合模型中的例子一样。</p>
</div>
</div>
<div class="section" id="id13">
<h2>6.5 总结<a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h2>
<p>许多问题可以描述为由不同的组分组成的总体群体。当知道每个观测数据属于哪个组分时，我们就可以将每个组分具体建模为一个单独的组。然而，很多时候无法直接访问这些信息，因此使用混合模型对该数据建模可能更合适。此时可以使用混合模型，以捕获数据中真实的组分；或者作为一种通用的统计技巧，通过组合简单分布来模拟复杂分布（类似于变分推断那样）；我们甚至可以尝试在中间做些什么。</p>
<p>本章将混合模型分为三类–有限混合模型、无限混合模型和连续混合模型。</p>
<p>（1）有限混合模型是两个或多个分布的有限加权混合，每个分布或组分代表数据的一个子群组。原则上组分几乎可以是我们认为有用的任何东西，从简单分布（如高斯或泊松）到复杂对象（如分层模型或神经网络）。从概念上讲，要求解混合模型，需要做的就是将每个数据点适当地分配给其中一个组分，可以通过引入隐变量 <span class="math notranslate nohighlight">\(z\)</span> 来实现这一点。我们使用了类别分布（最一般的离散分布）和狄利克雷先验（贝塔分布的 <span class="math notranslate nohighlight">\(n\)</span> 维推广）。对离散变量<span class="math notranslate nohighlight">\(z\)</span> 进行采样可能会遇到问题，因此可以考虑将其边缘化。<code class="docutils literal notranslate"><span class="pre">PyMC3</span></code> 包括一个正态混合分布和一个可以执行边缘化计算的混合分布，这使得构建混合模型变得更容易。</p>
<ul class="simple">
<li><p>使用混合模型时常见的问题是：这些模型可能会导致标签切换，而这是一种不可辨识的形式。消除不可辨识性的一种方法是强制对组分进行排序，使用<code class="docutils literal notranslate"><span class="pre">PyMC3</span></code>，可以通过 <code class="docutils literal notranslate"><span class="pre">pm.potential()</span></code> 或有序转换来实现这一点。</p></li>
<li><p>有限混合模型的一个挑战是如何确定组分数量。一种解决方案是围绕估计的组分数量对多个模型进行比较，如果可能的话，应根据手头的问题域来指导该估计。另一种选择是尝试从数据中自动估计组分数量。为此引入了狄利克雷过程的概念，我们用它来考虑无限混合模型。狄利克雷过程是狄利克雷分布的无限维版本，可以用它来建立非参数混合模型。</p></li>
</ul>
<p>作为本章结语，还简要讨论了有多少模型可以解释为连续混合模型，如贝塔–二项式（用于抛硬币问题的模型）、负二项模型、学生 <span class="math notranslate nohighlight">\(t\)</span> 分布，甚至分层模型等。</p>
</div>
<div class="section" id="id14">
<h2>6.6 习题<a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h2>
<p><img alt="" src="https://gitee.com/XiShanSnow/imagebed/raw/master/images/articles/spatialPresent_20210505200439_80.webp" /></p>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
            <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="chapter05-ModelComparison.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">第 5 章 模型比较与模型平均</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="chapter07-GaussianProcesses.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">第 7 章 高斯过程</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
        
        </div>
    </div>
    <footer class="footer">
    <div class="container">
      <p>
        
          By Osvaldo Martin<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>